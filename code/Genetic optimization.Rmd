---
title: "Optimization using GA"
output: html_document
---

## Derive parameters

- Read data

```{r}
library(readr)
library(dplyr)
library(lubridate)

# Passenger drop on, off data
passen_final<-read_csv("data/passen_final.csv")

# DTG data of taxis
dtg_final<-read_csv("data/dtg_final_saved.csv")

# Median travel time between zones
TravelTime<-read_csv("data/TravelTime.csv")

# All passenger pick-up/drop-off in 3 months
### For derive standard deviation of demand

passen_all<-read_csv("data/passen_all.csv")

# Road length by grid (unit: kilometer)
road_length <- read.csv("data/road_length_by_grid.csv")
road_length<- road_length %>% filter(grid_id %in% ROI) %>% select(grid_id,LengthSum) %>% arrange(grid_id)
```

- Parameters

```{r}
# Time index; 30 minutes intervals
Time<-ymd_hms("2017-03-02 00:00:00")+hours(0:23)
Time<-c(Time,Time + minutes(30)) %>% sort()

# Length of grid (1km)
L<-1

# Road density by zones
Rho<-road_length$LengthSum # Road density by grids

N<-42 # Number of grids
M<-5
Phi <-vector("list",48) # Call demand density of zones #Phi
Xi <-vector("list",48) # Street demand density of zones #Xi 
k<-0.1 # Ratio between Street and Call demand
Psi<-vector("list",48) # Arrival rate of zones 

Eta<-vector("list",48) # Maximum discharge rate at hubs 

A <- vector("list",48) # Density of vacant vehicles at zones
B <- vector("list",48) # Density of vacant vehicles at stations
v <- 30 # Vehicle speed
Epsilon <- vector("list",48) # Travel time between zones
```


## Data preprocessing for calculating passengers' demand
- 승하차 자료를 이용하여 수요를 추출
- 3월 2일 오전 12시부터 오후 11시 45분까지 60분 간격으로 총 48개
- Grid의 갯수는 총 42개

```{r}
# 42 Grids
ROI<-sort(c(61, 105, 136, 146, 154, 168, 184, 189, 190, 191, 194, 196, 199, 206, 225, 229, 230, 231, 233, 240, 241,
       245, 246, 251, 253, 257, 258, 260, 266, 268, 318, 320, 375, 391, 395, 400, 424, 442, 459, 464, 465, 468))

ROI_hub <- c(91, 92, 94, 95, 99)

# Make 30 minutes interval
passen_final$dprt_time_30min <- floor_date(passen_final$dprt_time,"30 minutes")
passen_final$arrvl_time_30min <- floor_date(passen_final$arrvl_time,"30 minutes")
```

- Street-hailing rate(Kxi) and Calling rate(Phi)

```{r}
# 42개의 그리드에서 발생한 통행만 추출 > 각 그리드별/시간대별 수요 도출 
tmp<-passen_final %>% filter(dprt_grid %in% ROI, dprt_st_id ==0) %>% group_by(dprt_grid,dprt_time_30min) %>% summarise(n=n())
tmp2<-data.frame(grid_id=rep(sort(ROI),each=48),time=Time)
tmp2 <-tmp2 %>% left_join(tmp, by=c("grid_id"="dprt_grid","time"="dprt_time_30min"))
tmp2[is.na(tmp2$n),]$n<-0

# Call과 Street를 구분
tmp2$Phi<-tmp2$n*k
tmp2$Xi<-tmp2$n*(1-k)
tmp2<-tmp2 %>% arrange(time,grid_id)

# Save Phi and Xi to list
for(i in 1:48) {
 Phi[[i]]<-tmp2$Phi[(N*i-N+1):(N*i)] 
} 

for(i in 1:48) {
 Xi[[i]]<-tmp2$Xi[(N*i-N+1):(N*i)] 
} 
```


- Arrival rate at zones (Psi)

```{r}
tmp <- passen_final %>% filter(arrvl_grid %in% ROI) %>% group_by(arrvl_grid,arrvl_time_30min) %>% summarise(n=n())
arate<-data.frame(grid_id=rep(sort(ROI),each=48),time=Time)
arate <-arate %>% left_join(tmp, by=c("grid_id"="arrvl_grid","time"="arrvl_time_30min"))
arate[is.na(arate$n),]$n<-0

for(i in 1:48) {
 Psi[[i]]<-arate$n[(N*i-N+1):(N*i)] 
} 
```

- Maximum discharge rate at hubs (Eta)

```{r}
# Station 
tmp<-passen_final %>% filter(dprt_grid %in% ROI, dprt_st_id !=0) %>% group_by(dprt_st_id,dprt_time_30min) %>% summarise(n=n())
drate<-data.frame(dprt_st_id=rep(sort(unique(tmp$dprt_st_id)),each=48),time=Time)
drate <-drate %>% left_join(tmp, by=c("dprt_st_id"="dprt_st_id","time"="dprt_time_30min"))
drate[is.na(drate$n),]$n<-0

for(i in 1:48) {
 Eta[[i]]<-drate$n[(M*i-M+1):(M*i)] 
}
```

## DTG raw data를 이용한 빈택시 댓수 가공 (A, B)
- dtg_final2 를 이용함
- 3월 2일 오전 12시부터 오후 12시 00분까지 30분 간격으로 총 48개
- 매 시간마다의 빈차 댓수 매핑
- Grid의 갯수는 총 42개
- Vacant taxis in zones (A)

```{r}
# Make time variable every 30 minutes
dtg_final$dprt_time_30min <- floor_date(dtg_final$time2,"30 minutes")

# Find the number of empty taxis in each grid every hour
tmp<-dtg_final %>% 
  filter(time2 %in% Time, # Filter DTG-raw only in every hour 
         onoff==0 # Extract only vacant taxi 
         )%>% 
  group_by(dprt_grid, dprt_time_30min) %>% # Grid 번호, 시각으로 그룹
  summarise(A=n()) # 각 그룹별 택시 댓수 추출

# 빈 시간대, 0값으로 채우기 
tmp2<-data.frame(grid_id=rep(sort(ROI),each=48),time=Time)
tmp2 <-tmp2 %>% left_join(tmp, by=c("grid_id"="dprt_grid","time"="dprt_time_30min"))
tmp2[is.na(tmp2$A),]$A<-0
tmp2<-tmp2 %>% arrange(time,grid_id)

# A를 list로 저장
for(i in 1:48) {
 A[[i]]<-tmp2$A[(N*i-N+1):(N*i)] 
} 
```

- Vacant taxis in hubs (B)

```{r}
# Find the number of empty taxis in each grid every hour
tmp<-dtg_final %>% 
  filter(time2 %in% Time, # Filter DTG-raw only in every hour 
         onoff==0 # Extract only vacant taxi 
         )%>% 
  group_by(st_id, dprt_time_30min) %>% # Grid 번호, 시각으로 그룹
  summarise(B=n()) # 각 그룹별 택시 댓수 추출

# 빈 시간대, 0값으로 채우기 
tmp2<-data.frame(st_id=rep(ROI_hub,each=48),time=Time)
tmp2 <-tmp2 %>% left_join(tmp, by=c("st_id"="st_id","time"="dprt_time_30min"))
tmp2[is.na(tmp2$B),]$B<-0
tmp2<-tmp2 %>% arrange(time,st_id)

# A를 list로 저장
for(i in 1:48) {
 B[[i]]<-tmp2$B[(M*i-M+1):(M*i)] 
} 
```


## Travel time 도출 (E) - 미완성

- 각 grid에 차량이 존재하지 않을 경우, 가장 가까운 지역의 차량이 호출된다고 가정
- 이를 표현하기 위해서는 그리드간의 통행시간 정보가 필요함
- TravelTIme object는 2017년 1월부터 3월까지의 승하차 자료를 기반으로 grid 간 통행 시간의 median 값을 도출한 테이블임
- 이 테이블을 기준으로 차량이 한대도 없는 그리드의 Waiting time 도출이 가능함 

```{r}
for(i in 1:48) {
 epsilon[[i]]<-TravelTime %>% filter(dprt_time_60min == Time[i]) 
} 
```



# Optimization using GA

## Desicion variable

```{r}
X <- 0
Y <- 0
i<-2
T_1 <- 0
T_2 <- 0
```

## Constraint

- Cons 1
X : Relative number of relocation taxis of all zones
Y : Relative number of relocation taxis of all hubs
K : Additional vehicles to have to be put

```{r}
X + Y + K == 0
```

- Cons 2
```{r}
A_delta <- A[[i]] + (-Xi[[i]]-Phi[[i]]+Psi[[i]]) + X # Equation (3) 
```

- Cons 3 
```{r}
B_delta <- B[[i]] - Eta[[i]] - 1.96 * SD_Eta[[i]] + Y
B_delta >= 0
```

- Cons 4
```{r}
A_delta - 1.96(SD_Xi[[i]] + SD_Phi[[i]] + SD_Psi[[i]]) + Y >= 0
```

- Cons 5 (Remove)

- Cons 6 (Average assigned time of calling)

```{r}
CallTime <- (pi^0.5*2)/(2^1.5*v)/(A_delta^0.5 + A[[i]]^0.5)*60
CallTime[is.nan(CallTime)] <- 999
```

- Cons 7 (Average assigned time of street-hailing)

```{r}
StreetTime <- Rho[[i]]/v/(A_delta - A[[i]])*log((A_delta +1)/(A[[i]]+1))*60
StreetTime[is.nan(StreetTime)] <- 999
```

## Construct GA module

```{r}
library(GA)
```





